console.log("LLM Agent: Background script loaded");let pageContexts=new Map,chatHistory=[];chrome.runtime.onInstalled.addListener((()=>{console.log("LLM Agent: Extension installed"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),chrome.contextMenus.create({id:"open-llm-agent",title:"Open LLM Agent",contexts:["page","selection","link"]}),chrome.contextMenus.create({id:"add-page-to-context",title:"Add Page to LLM Context",contexts:["page"]}),chrome.contextMenus.create({id:"add-selection-to-context",title:"Add Selection to LLM Context",contexts:["selection"]}),chrome.contextMenus.create({id:"add-selection-to-journal",title:"Add to Journal",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(((e,t)=>{switch(console.log("Context menu clicked:",e.menuItemId),e.menuItemId){case"open-llm-agent":chrome.sidePanel.open({windowId:t.windowId}).catch((()=>{chrome.sidePanel.open({tabId:t.id}).catch((e=>{console.error("Failed to open side panel:",e)}))}));break;case"add-page-to-context":chrome.tabs.sendMessage(t.id,{type:"GET_PAGE_CONTENT"},(e=>{e&&!chrome.runtime.lastError&&(pageContexts.set(e.url,e),console.log("Added page to context via context menu:",e.url))}));break;case"add-selection-to-context":if(e.selectionText){const o={url:t.url,title:`Selection from ${t.title}`,content:e.selectionText,timestamp:Date.now()};pageContexts.set(`selection_${Date.now()}`,o),console.log("Added selection to context:",e.selectionText.substring(0,50)+"...")}break;case"add-selection-to-journal":if(e.selectionText){const o={type:"quote",content:e.selectionText,sourceUrl:t.url,sourceTitle:t.title,timestamp:(new Date).toISOString()};chrome.storage.local.set({pendingJournalEntry:o},(()=>{console.log("Stored pending journal entry for sidebar pickup")})),chrome.sidePanel.open({windowId:t.windowId}).catch((()=>{chrome.sidePanel.open({tabId:t.id}).catch((e=>{console.error("Failed to open side panel:",e)}))}))}}})),chrome.tabs.onUpdated.addListener(((e,t,o)=>{"complete"===t.status&&o.url&&!o.url.startsWith("chrome://")&&setTimeout((()=>{chrome.tabs.sendMessage(e,{type:"GET_PAGE_CONTENT"},(e=>{e&&!chrome.runtime.lastError&&(pageContexts.set(e.url,e),console.log("Auto-captured page content for:",e.url))}))}),2e3)})),chrome.runtime.onMessage.addListener(((e,t,o)=>{switch(console.log("Background received message:",e.type),e.type){case"PAGE_DATA":e.data&&(pageContexts.set(e.data.url,e.data),console.log("Stored page data for:",e.data.url));break;case"GET_ALL_TABS":return chrome.tabs.query({},(e=>{const t=e.map((e=>({id:e.id,url:e.url,title:e.title,active:e.active})));o({tabs:t})})),!0;case"GET_CURRENT_TAB":return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?o({tab:e[0]}):o({tab:null})})),!0;case"GET_CURRENT_TAB_CONTENT":return chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?chrome.tabs.sendMessage(e[0].id,{type:"GET_PAGE_CONTENT"},(e=>{e&&!chrome.runtime.lastError?o(e):o(null)})):o(null)})),!0;case"GET_TAB_CONTENT":return e.tabId&&chrome.tabs.sendMessage(e.tabId,{type:"GET_PAGE_CONTENT"},(e=>{o(e)})),!0;case"GET_STORED_CONTEXTS":o({contexts:Array.from(pageContexts.values())});break;case"CLEAR_CONTEXTS":pageContexts.clear(),o({success:!0});break;case"SAVE_CHAT_HISTORY":chatHistory=e.history||[],o({success:!0});break;case"GET_CHAT_HISTORY":o({history:chatHistory})}})),setInterval((()=>{if(pageContexts.size>50){const e=Array.from(pageContexts.entries());e.sort(((e,t)=>t[1].timestamp-e[1].timestamp)),pageContexts.clear(),e.slice(0,50).forEach((([e,t])=>{pageContexts.set(e,t)})),console.log("Cleaned up old contexts, keeping 50 most recent")}}),3e5);